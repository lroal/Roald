// Copyright 2002 - 2007 Peter L. Blum, All Rights Reserved, www.PeterBlum.com
// Peter's Date Package Release 2.0.4

function MSC_ClickDate(pCalId,pDCId,pE){PDP_UnselectPage();var vDC=PDP_GetById(pDCId);var vRole=parseInt(PDP_GetAtt(vDC,"CellRole","0"));if(vRole>=12)return;var vCal=PDP_GetById(pCalId);if(!PDP_CtlInited(vCal))return;var vAO=vCal.AO;if(vAO.KeyB)CSC_SetFocus(pCalId);var vShift=MSC_UseRange(vAO,pE,1);MSC_PrepSelDate(vAO);var vChg=false;vAO.MaxExc=false;if(vAO.UnselF&&vAO.SelCount)MSC_UnselectAll(vAO);if(!vShift||(vAO.LDtTg==null)||(vAO.SelCount==0)||((vAO.SelCount==1)&&(vDC.Date==vAO.LDtTg))){var vR=MSC_ChangeSelDates(vAO,vDC.Date,2);if(!vR){if(vAO.MaxExc){MSC_DrawMsgBody(vAO);if(vAO.MaxSelMsg)alert(vAO.MaxSelMsg);}return;}vChg=true;if(vR==1){CSC_UnselectDayCell(vAO,pDCId);MSC_RemoveClSl(vAO,pDCId);}else{CSC_SelectDayCell(vAO,vDC);MSC_SetCellSel(vAO,pDCId);}vAO.LDtTg=vDC.Date;vAO.LDtSel=(vR==2);MSC_SetupNextClick(vAO,vDC.Date,null,vR==1,false);}else{var vO=MSC_GetMO(vAO,vDC.Date);var vBit=1<<(vDC.Date.getUTCDate()-1);var vSel=(vAO.SelDates[vO]&vBit)>0;var vSelTicks=vDC.Date.valueOf();var vLastTicks=vAO.LDtTg.valueOf();if(vSel){var vAdv=vSelTicks>=vLastTicks;var vAdd=vAdv?86400000:-86400000;for(var vDateTicks=vLastTicks;vAdv?vDateTicks<=vSelTicks:vDateTicks>=vSelTicks;vDateTicks+=vAdd){var vNDate=new Date(vDateTicks);var vR=MSC_ChangeSelDates(vAO,vNDate,0);if(vR==1){vAO.LDtTg=vNDate;vAO.LDtSel=false;vChg=true;}}}else{if(vAO.RngMd){MSC_CalcFirstLast(vAO);if(vDC.Date<vAO.FirstSel)vLastTicks=vAO.FirstSel.valueOf();else if(vDC.Date>vAO.LastSel)vLastTicks=vAO.LastSel.valueOf();}var vAdv=vSelTicks>=vLastTicks;var vAdd=vAdv?86400000:-86400000;for(var vDateTicks=vLastTicks;vAdv?vDateTicks<=vSelTicks:vDateTicks>=vSelTicks;vDateTicks+=vAdd){var vNDate=new Date(vDateTicks);var vR=MSC_ChangeSelDates(vAO,vNDate,1);if(vR==2){vAO.LDtTg=vNDate;vAO.LDtSel=false;vChg=true;}else if((vR==0)&&vAO.MaxExc){break;}}}if(vChg){CSC_FillInWeekRows(pCalId,vAO);MSC_SetupNextClick(vAO,vAO.LDtTg,vDC.Date,vSel,false);}if(vAO.MaxExc){MSC_DrawMsgBody(vAO);if(vAO.MaxSelMsg)alert(vAO.MaxSelMsg);}}if(vChg){MSC_SaveSelDate(vAO);CSC_DrawDateLabel(vCal);CSC_OnSelectionChanged(vCal,false);}if(pE)PDP_StopEvent(pE);}function MSC_ClickWeek(pCalCId,pRowNum,pMV,pE){PDP_UnselectPage();var vMCId=CSC_MVCalId(pCalCId,pMV);var vDC=PDP_GetById(vMCId+"_"+(pRowNum*7+1));if(vDC&&vDC.Date){var vCal=PDP_GetById(pCalCId);if(!PDP_CtlInited(vCal))return;var vAO=vCal.AO;var vShift=MSC_UseRange(vAO,pE,0);if(vAO.UnselF&&vAO.SelCount)MSC_UnselectAll(vAO);var vChg=MSC_ToggleRange(vAO,vDC.Date,1,7,vShift,pMV)!=0;if(vChg)MSC_PointToWeek(pCalCId,pRowNum,pMV,pE);MSC_PostToggleRange(vCal,vAO,vChg);}if(pE)PDP_StopEvent(pE);}function MSC_ClickMonth(pCalCId,pMV,pE){PDP_UnselectPage();var vCal=PDP_GetById(pCalCId);if(!PDP_CtlInited(vCal))return;var vAO=vCal.AO;var vShift=MSC_UseRange(vAO,pE,0);if(vAO.UnselF&&vAO.SelCount)MSC_UnselectAll(vAO);var vDO=CSC_AddMonths(vAO.Year,vAO.Month,pMV);var vDate=PDP_MakeUTCDate(vDO.Y,vDO.M,1);var vNextMonth=PDP_MakeUTCDate(vDO.Y,vDO.M<11?vDO.M+1:0,1);var vLastDay=parseInt((vNextMonth.valueOf()-vDate.valueOf())/86400000);var vChg=MSC_ToggleRange(vAO,vDate,1,vLastDay,vShift,pMV)!=0;if(vChg)MSC_PointToMonth(pCalCId,pMV,pE);MSC_PostToggleRange(vCal,vAO,vChg);if(pE)PDP_StopEvent(pE);}function MSC_ClickDOW(pCalCId,pDOW,pMV,pE){PDP_UnselectPage();var vMCId=CSC_MVCalId(pCalCId,pMV);var vDC=PDP_GetById(vMCId+"_"+(pDOW+1));if(vDC&&vDC.Date){var vCal=PDP_GetById(pCalCId);if(!PDP_CtlInited(vCal))return;var vAO=vCal.AO;var vShift=MSC_UseRange(vAO,pE,0);if(vAO.UnselF&&vAO.SelCount)MSC_UnselectAll(vAO);var vDCs=vAO.DayCells;var vO=parseInt((vDC.Date.valueOf()-vDCs[0].Date.valueOf())/86400000);var vNumRows=6;var vE=vO+7*5;if((vE<vDCs.length)&&(PDP_GetAtt(vDCs[vE],"MonthOffset","0")!="0")){vNumRows--;if(PDP_GetAtt(vDCs[vE-7],"MonthOffset","0")!="0")vNumRows--;}var vChg=MSC_ToggleRange(vAO,vDC.Date,7,vNumRows,vShift,pMV)!=0;if(vChg)MSC_PointToDOW(pCalCId,pDOW,pMV,pE);MSC_PostToggleRange(vCal,vAO,vChg);}if(pE)PDP_StopEvent(pE);}function MSC_ToggleRange(pAO,pStartDate,pAddDays,pTotalDates,pShift,pMV){function IsMonth(pDate,pDO){return!vCMOnly||((pDO.M==pDate.getUTCMonth())&&(pDO.Y==pDate.getUTCFullYear()));}if(pAddDays!=1)pShift=false;MSC_PrepSelDate(pAO);var vR=0;var vStartTicks=pStartDate.valueOf();var vDayTicks=86400000;var vCMOnly=pAO.SelCMO;if((pShift||pAO.RngMd)&&(pAO.SelCount>0)){vCMOnly=false;MSC_CalcFirstLast(pAO);var vFirstTicks=pAO.FirstSel?pAO.FirstSel.valueOf():0;var vLastTicks=pAO.LastSel?pAO.LastSel.valueOf():0;if(vStartTicks<vFirstTicks){var vUpperTicks=vStartTicks+vDayTicks*pTotalDates;if(vUpperTicks>vLastTicks){var vD=(vUpperTicks-vLastTicks)/vDayTicks;if(MSC_ToggleRange(pAO,new Date(vLastTicks),1,vD)>0)vR=2;}vFirstTicks-=vDayTicks;pTotalDates=parseInt(((vFirstTicks-vStartTicks)/vDayTicks)+1);pAddDays=-1;vStartTicks=vFirstTicks;}else if(vStartTicks>vLastTicks){pTotalDates=parseInt(((vStartTicks-vLastTicks)/vDayTicks)+pTotalDates);vStartTicks=vLastTicks;}else if((vStartTicks<vLastTicks)&&(vStartTicks>vFirstTicks)){var vD=parseInt((vLastTicks-vStartTicks)/vDayTicks);if(vD+1>pTotalDates)pTotalDates=vD+1;}}var vHasSel=true;var vDateTicks=vStartTicks;var vDO=CSC_AddMonths(pAO.Year,pAO.Month,pMV);for(var vI=0;vI<pTotalDates;vI++){var vDate=new Date(vDateTicks);if(IsMonth(vDate,vDO)&&MSC_IsSelectable(pAO,vDate)&&!MSC_IsSelDate(pAO,vDate)){vHasSel=false;break;}vDateTicks=vDateTicks+vDayTicks*pAddDays;}if(vHasSel){vDateTicks=vStartTicks;for(var vI=0;vI<pTotalDates;vI++){var vDate=new Date(vDateTicks);var vO=MSC_GetMO(pAO,vDate);var vBit=1<<(vDate.getUTCDate()-1);var vSel=(pAO.SelDates[vO]&vBit)>0;if(IsMonth(vDate,vDO)&&MSC_IsSelectable(pAO,vDate)&&vSel){pAO.SelDates[vO]=pAO.SelDates[vO]&~vBit;pAO.SelCount--;pAO.CalcFChg=true;pAO.LDtTg=pAO.SelCount?vDate:null;pAO.LDtSel=false;vR=1;}vDateTicks=vDateTicks+vDayTicks*pAddDays;}if(pAO.RngMd&&(pAO.SelCount>0)){MSC_CalcFirstLast(pAO);var vFirstTicks=pAO.FirstSel?pAO.FirstSel.valueOf():0;var vLastTicks=pAO.LastSel?pAO.LastSel.valueOf():0;if(vDateTicks<vFirstTicks)pAO.LDtTg=pAO.FirstSel;else pAO.LDtTg=pAO.LastSel;}}else{vDateTicks=vStartTicks;for(var vI=0;vI<pTotalDates;vI++){var vDate=new Date(vDateTicks);var vO=MSC_GetMO(pAO,vDate);var vBit=1<<(vDate.getUTCDate()-1);var vSel=(pAO.SelDates[vO]&vBit)>0;if(IsMonth(vDate,vDO)&&MSC_IsSelectable(pAO,vDate)&&!vSel){if(pAO.MaxSel&&(pAO.MaxSel<=pAO.SelCount)){pAO.MaxExc=true;break;}pAO.SelDates[vO]=pAO.SelDates[vO]|vBit;pAO.SelCount++;pAO.CalcFChg=true;pAO.LDtTg=vDate;pAO.LDtSel=true;if((pAO.LowMSel==null)||(pAO.LowMSel>vO))pAO.LowMSel=vO;if((pAO.HighMSel==null)||(pAO.HighMSel<vO))pAO.HighMSel=vO;vR=2;}vDateTicks=vDateTicks+vDayTicks*pAddDays;}if(pAO.RngMd){MSC_CalcFirstLast(pAO);if(pAddDays==-1)pAO.LDtTg=pAO.FirstSel;else pAO.LDtTg=pAO.LastSel;}}return vR;}function MSC_PostToggleRange(pCFld,pAO,pChg){if(pChg)CSC_FillInWeekRows(pCFld.id,pAO);if(pAO.MaxExc){MSC_DrawMsgBody(pAO);if(pAO.MaxSelMsg)alert(pAO.MaxSelMsg);}if(pChg){MSC_SaveSelDate(pAO);CSC_DrawDateLabel(pCFld);CSC_OnSelectionChanged(pCFld,false);}}function MSC_ChangeSelDates(pAO,pDate,pAction){var vCal=PDP_GetById(pAO.CID);var vO=MSC_GetMO(pAO,pDate);var vBit=1<<(pDate.getUTCDate()-1);var vSel=(pAO.SelDates[vO]&vBit)>0;if(pAction==2)pAction=vSel?0:1;if(pAction==0){if(vSel){pAO.SelDates[vO]=pAO.SelDates[vO]&~vBit;pAO.SelCount--;pAO.CalcFChg=true;return 1;}}else if(pAction==1){if(!vSel){if(!CSC_DateSelectable(vCal,pDate.getUTCFullYear(),pDate.getUTCMonth(),pDate.getUTCDate()))return 0;if(pAO.MaxSel&&(pAO.MaxSel<=pAO.SelCount)){pAO.MaxExc=true;return 0;}pAO.SelDates[vO]=pAO.SelDates[vO]|vBit;pAO.SelCount++;pAO.CalcFChg=true;if((pAO.LowMSel==null)||(pAO.LowMSel>vO))pAO.LowMSel=vO;if((pAO.HighMSel==null)||(pAO.HighMSel<vO))pAO.HighMSel=vO;return 2;}}return 0;}function MSC_UnselectAll(pAO){if(pAO.SelCells)for(var vI=0;vI<pAO.SelCells.length;vI++){var vDCId=pAO.SelCells[vI];CSC_UnselectDayCell(pAO,vDCId);}MSC_SetDV(pAO,null);MSC_ClearCellSel(pAO);}function MSC_IsSelDate(pAO,pDate){MSC_PrepSelDate(pAO);if(pDate){var vO=MSC_GetMO(pAO,pDate);return(pAO.SelDates[vO]&(1<<(pDate.getUTCDate()-1)))>0;}else return false;}function MSC_GetMO(pAO,pDate){return(pDate.getUTCFullYear()*12)+pDate.getUTCMonth()-pAO.FstMC;}function MSC_PrepSelDate(pAO){if(pAO.FstMC==null){var vF=PDP_GetById(pAO.CID+"_SelDates");pAO.SelDatesF=vF;var vP=vF.value.split('|');pAO.FstMC=parseInt(vP[1]);pAO.TotMC=parseInt(vP[2]);pAO.SaveHead=vP[0]+"|"+vP[1]+"|"+vP[2]+"|";if(vP[3]){var vLDT=vP[3].split('-');pAO.LDtTg=PDP_MakeUTCDate(parseInt(vLDT[0]),parseInt(vLDT[1])-1,parseInt(vLDT[2]));pAO.LDtSel=vLDT.length==3;}else{pAO.LDtTg=null;pAO.LDtSel=false;}pAO.SelCount=parseInt(vP[4]);pAO.SelDates=new Array(pAO.TotMC);for(var vI=0;vI<pAO.TotMC;vI++)pAO.SelDates[vI]=parseInt(vP[5+vI]);}}function MSC_SaveSelDate(pAO){if(pAO.FstMC==null)return;var vS=pAO.SaveHead;var vD=pAO.LDtTg;if(vD){vS=vS+vD.getUTCFullYear()+"-"+new String(vD.getUTCMonth()+1)+"-"+vD.getUTCDate();if(!pAO.LDtSel)vS=vS+"-";}vS=vS+"|"+pAO.SelCount+"|"+pAO.SelDates.join('|');pAO.SelDatesF.value=vS;}function MSC_GetDV(pAO){MSC_PrepSelDate(pAO);if(pAO.SelCount==0)return null;else{MSC_CalcFirstLast(pAO);return pAO.FirstSel;}}function MSC_CalcFirstLast(pAO){if(pAO.CalcFChg==false)return;var vL=pAO.LowMSel!=null?pAO.LowMSel:0;var vH=pAO.HighMSel!=null?pAO.HighMSel:pAO.TotMC-1;var vFLM=null;var vFHM=null;for(var vI=vL;vI<=vH;vI++){if(pAO.SelDates[vI]){if(vFLM==null)vFLM=vI;vFHM=vI;}}if(vFLM==null){pAO.FirstSel=null;pAO.LastSel=null;}else{var vMbits=pAO.SelDates[vFLM];for(var vDay=0;vDay<31;vDay++)if(vMbits&(1<<vDay)){pAO.FirstSel=MSC_GetDateFromSelDates(pAO,vFLM,vDay+1);break;}vMbits=pAO.SelDates[vFHM];for(var vDay=30;vDay>=0;vDay--)if(vMbits&(1<<vDay)){pAO.LastSel=MSC_GetDateFromSelDates(pAO,vFHM,vDay+1);break;}pAO.LowMSel=vFLM;pAO.HighMSel=vFHM;}pAO.CalcFChg=false;}function MSC_IsSelectable(pAO,pDate){if(pAO.MnDTicks==null){var vMinDate=PDP_MakeUTCDate(pAO.MinY,pAO.MinM,pAO.MinD);pAO.MnDTicks=(vMinDate!=null)?vMinDate.valueOf():0;var vMaxDate=PDP_MakeUTCDate(pAO.MaxY,pAO.MaxM,pAO.MaxD);pAO.MxDTicks=(vMaxDate!=null)?vMaxDate.valueOf():0;}var vDateTicks=pDate.valueOf();if(vDateTicks<pAO.MnDTicks)return false;if((pAO.MxDTicks>0)&&(pAO.MxDTicks<vDateTicks))return false;if(!CSC_DateSelectable(PDP_GetById(pAO.CID),pDate.getUTCFullYear(),pDate.getUTCMonth(),pDate.getUTCDate()))return false;return true;}function MSC_GetDateFromSelDates(pAO,pMO,pDay){var vY=parseInt((pAO.FstMC+pMO)/12);var vM=(pAO.FstMC+pMO)%12;return PDP_MakeUTCDate(vY,vM,pDay);}function MSC_SetDV(pAO,pDate){MSC_PrepSelDate(pAO);pAO.MaxExc=false;if(pDate){if(pAO.SDId!=""){var vSD=SD_FindDate(pAO.SDId,pDate);if((vSD!=null)&&!vSD.Sel)return false;}var vO=MSC_GetMO(pAO,pDate);var vBits=1<<(pDate.getUTCDate()-1);if((pAO.SelDates[vO]&vBits)==0){if(pAO.MaxSel&&(pAO.MaxSel<=pAO.SelCount)){pAO.MaxExc=true;MSC_DrawMsgBody(pAO);return false;}pAO.SelDates[vO]=pAO.SelDates[vO]|vBits;pAO.SelCount++;pAO.CalcFChg=true;}if((pAO.LowMSel==null)||(pAO.LowMSel>vO))pAO.LowMSel=vO;if((pAO.HighMSel==null)||(pAO.HighMSel<vO))pAO.HighMSel=vO;pAO.LDtTg=pDate;pAO.LDtSel=true;}else if(pAO.SelCount>0){for(var vI=0;vI<pAO.TotMC;vI++){pAO.SelDates[vI]=0;}pAO.SelCount=0;pAO.CalcFChg=true;}MSC_SaveSelDate(pAO);return true;}function MSC_GetDateLabel(pAO){MSC_CalcFirstLast(pAO);if(pAO.SelCount==0)return pAO.CDL0;else if(pAO.SelCount==1){var vS=pAO.CDL1.replace("{DATE}",PDP_FmtDate2(pAO.FirstSel,pAO.CurDPat,pAO.CurDFmt));return vS;}else{var vS=pAO.CDL2;vS=vS.replace("{FIRSTDATE}",PDP_FmtDate2(pAO.FirstSel,pAO.CDPat2,pAO.CDFmt2));vS=vS.replace("{LASTDATE}",PDP_FmtDate2(pAO.LastSel,pAO.CDPat2,pAO.CDFmt2));vS=vS.replace("{COUNT}",pAO.SelCount.toString());return vS;}}function MSC_DrawMsgBody(pAO){function AddShiftKeyText(pPat,pFmt){if(!pAO.RngMd&&!pAO.UnselF){vT=pAO.MCDSK;if(pAO.MCDSK_TD==null)pAO.MCDSK_TD=vT.indexOf("{TOGGLEDDATE}")>-1;if(pAO.MCDSK_TD)vT=vT.replace("{TOGGLEDDATE}",PDP_FmtDate2(pAO.LDtTg,pPat,pFmt));vS=vS+" "+vT;}}if(pAO.MsgBodyFld){MSC_PrepSelDate(pAO);MSC_CalcFirstLast(pAO);var vS="";if(pAO.MaxExc)vS=pAO.MCDEX;if(pAO.MCNOn){if(pAO.MCNCss)vS=vS+"<span class='"+pAO.MCNCss+"'>";if(pAO.MCNextClick)vS=vS+pAO.MCNextClick;else vS=vS+"<br />";if(pAO.MCNCss)vS=vS+"</span>";}if(pAO.SelCount==0)vS=vS+pAO.MCD0;else if(pAO.SelCount==1){vS=vS+pAO.MCD1;AddShiftKeyText(pAO.MCDPat,pAO.MCDFmt);}else{vS=vS+pAO.MCD2;AddShiftKeyText(pAO.MCDPat2,pAO.MCDFmt2);}if(vS.indexOf("{")>-1){vS=vS.replace("{COUNT}",pAO.SelCount.toString());if(pAO.MCDClear)vS=vS.replace("{CLEAR}",pAO.MCDClear);if(pAO.SelCount==1){var vDate=PDP_FmtDate2(pAO.FirstSel,pAO.MCDPat,pAO.MCDFmt);vS=vS.replace("{DATE}",vDate);vS=vS.replace("{FIRSTDATE}",vDate);}else if(pAO.SelCount>0){var vDate=PDP_FmtDate2(pAO.FirstSel,pAO.MCDPat2,pAO.MCDFmt2);var vDate2=PDP_FmtDate2(pAO.LastSel,pAO.MCDPat2,pAO.MCDFmt2);vS=vS.replace("{FIRSTDATE}",vDate);vS=vS.replace("{DATE}",vDate);vS=vS.replace("{LASTDATE}",vDate2);}}pAO.MsgBodyFld.innerHTML=vS;}}function MSC_PointToDate(pCalId,pDCId,pE){var vDC=PDP_GetById(pDCId);var vRole=parseInt(PDP_GetAtt(vDC,"CellRole","0"));if(vRole>=12){MSC_ClearNextClick(pCalId);return;}var vCal=PDP_GetById(pCalId);if(!vCal.AO)return;var vAO=vCal.AO;var vShift=MSC_UseRange(vAO,pE,0);vAO.LastShift=vShift;vAO.LastNCElement=vDC;if(vAO.RngMd)vShift=true;MSC_PrepSelDate(vAO);if(!vShift||(vAO.LDtTg==null)||(vAO.SelCount==0)||((vAO.SelCount==1)&&(vDC.Date==vAO.LDtTg))){var vSel=MSC_IsSelDate(vAO,vDC.Date);MSC_SetupNextClick(vAO,vDC.Date,null,!vSel,true);}else{var vO=MSC_GetMO(vAO,vDC.Date);var vBit=1<<(vDC.Date.getUTCDate()-1);var vSel=(vAO.SelDates[vO]&vBit)>0;if(vSel){MSC_SetupNextClick(vAO,vDC.Date,vAO.LDtTg,false,true);}else{var vLast=vAO.LDtTg;if(vAO.RngMd){MSC_CalcFirstLast(vAO);if(vDC.Date<vAO.FirstSel)vLast=vAO.FirstSel;else if(vDC.Date>vAO.LastSel)vLast=vAO.LastSel;}MSC_SetupNextClick(vAO,vDC.Date,vLast,true,true);}}}function MSC_PointToWeek(pCalCId,pRowNum,pMV,pE){var vMCId=CSC_MVCalId(pCalCId,pMV);var vDC=PDP_GetById(vMCId+"_"+(pRowNum*7+1));if(vDC&&vDC.Date){var vCal=PDP_GetById(pCalCId);if(!vCal.AO)return;var vAO=vCal.AO;var vShift=MSC_UseRange(vAO,pE,0);MSC_PointToRange(vAO,vDC.Date,1,7,vShift,pMV);vAO.LastNCElement=PDP_GetById(vMCId+"_WK"+pRowNum);}}function MSC_PointToMonth(pCalCId,pMV,pE){var vCal=PDP_GetById(pCalCId);if(!vCal.AO)return;var vAO=vCal.AO;var vMCId=CSC_MVCalId(pCalCId,pMV);var vShift=MSC_UseRange(vAO,pE,0);var vDO=CSC_AddMonths(vAO.Year,vAO.Month,pMV);var vDate=PDP_MakeUTCDate(vDO.Y,vDO.M,1);var vNextMonth=PDP_MakeUTCDate(vDO.M<11?vDO.Y:vDO.Y+1,vDO.M<11?vDO.M+1:0,1);var vLastDay=parseInt((vNextMonth.valueOf()-vDate.valueOf())/86400000);MSC_PointToRange(vAO,vDate,1,vLastDay,vShift,pMV);vAO.LastNCElement=PDP_GetById(vMCId+"_DH0");}function MSC_PointToDOW(pCalCId,pDOW,pMV,pE){var vMCId=CSC_MVCalId(pCalCId,pMV);var vDC=PDP_GetById(vMCId+"_"+(pDOW+1));if(vDC&&vDC.Date){var vCal=PDP_GetById(pCalCId);if(!vCal.AO)return;var vAO=vCal.AO;MSC_ClearHilite(vAO);MSC_SetHiliteDOW(vAO,vDC,true);if(!vAO.MCNDOW)return;var vDayOfWeek=vDC.Date.getUTCDay();vAO.MCNextClick=vAO.MCNDOW.replace("{DOW}",PDP_DaysOfWeek[vDayOfWeek])+"<br />";MSC_DrawMsgBody(vAO);vAO.LastNCElement=PDP_GetById(vMCId+"_DH"+(1+pDOW));}}function MSC_PointToRange(pAO,pStartDate,pAddDays,pTotalDates,pShift,pMV){function IsMonth(pDate,pDO){return!vCMOnly||((pDO.M==pDate.getUTCMonth())&&(pDO.Y==pDate.getUTCFullYear()));}MSC_ClearHilite(pAO);pAO.LastShift=pShift;if(pAddDays!=1)pShift=false;MSC_PrepSelDate(pAO);var vR=0;var vStartTicks=pStartDate.valueOf();var vDayTicks=86400000;var vCMOnly=pAO.SelCMO;if((pShift||pAO.RngMd)&&(pAO.SelCount>0)){vCMOnly=false;MSC_CalcFirstLast(pAO);var vFirstTicks=pAO.FirstSel?pAO.FirstSel.valueOf():0;var vLastTicks=pAO.LastSel?pAO.LastSel.valueOf():0;if(vStartTicks<vFirstTicks){}else if(vStartTicks>vLastTicks){pTotalDates=parseInt(((vStartTicks-vLastTicks)/vDayTicks)+pTotalDates);vStartTicks=vLastTicks;}else if((vStartTicks<vLastTicks)&&(vStartTicks>vFirstTicks)){var vD=parseInt((vLastTicks-vStartTicks)/vDayTicks);if(vD+1>pTotalDates)pTotalDates=vD+1;}}var vHasSel=true;var vDateTicks=vStartTicks;var vDO=CSC_AddMonths(pAO.Year,pAO.Month,pMV);for(var vI=0;vI<pTotalDates;vI++){var vDate=new Date(vDateTicks);if(IsMonth(vDate,vDO)&&MSC_IsSelectable(pAO,vDate)&&!MSC_IsSelDate(pAO,vDate)){vHasSel=false;break;}vDateTicks=vDateTicks+vDayTicks*pAddDays;}vDateTicks=vStartTicks+vDayTicks*pAddDays*(pTotalDates-1);MSC_SetupNextClick(pAO,new Date(vStartTicks),new Date(vDateTicks),!vHasSel,true);}function MSC_UseRange(pAO,pE,pTestRM){if(pTestRM&&pAO.RngMd)return true;if(pAO.UnselF)return false;if((pE==null)&&(window.event))pE=window.event;return pE?PDP_IsShift(pE):false;}function MSC_SetHiliteRange(pAO,pDate1,pDate2,pSel){if(!pAO)return;if(!pAO.DayCells)return;if(!pDate2||(pDate1==pDate2))return;if(pDate1>pDate2){var vT=pDate1;pDate1=pDate2;pDate2=vT;}for(var vI=0;vI<pAO.DayCells.length;vI++){var vDC=pAO.DayCells[vI];if(vDC.Date<pDate1)continue;if(vDC.Date>pDate2)break;MSC_SetHiliteDay(pAO,vDC,pSel);}}function MSC_SetHiliteDay(pAO,pDC,pSel){if(!pAO)return;if(!pAO.HLDC)pAO.HLDC=new Array;if(pAO.UnselF)pSel=1;if(pDC.HLSOrig==null)pDC.HLSOrig=pDC.style.backgroundColor;if(MSC_IsSelectable(pAO,pDC.Date)){pDC.style.backgroundColor=pSel?pAO.HRSC:pAO.HRUC;pAO.HLDC[pAO.HLDC.length]=pDC;}}function MSC_SetHiliteDOW(pAO,pDC,pSel){if(!pAO)return;var vD=pDC.Date;var vIM=vD.getUTCMonth();if(PDP_GetAtt(pDC,"MonthOffset","0")!="0"){if(pAO.MV>1)vD=new Date(vD.valueOf()+7*86400000);vIM=vIM==11?0:vIM+1;}var vDCs=pAO.DayCells;var vO=parseInt((vD.valueOf()-vDCs[0].Date.valueOf())/86400000);for(;;vO=vO+7){if(vO>=vDCs.length)break;var vDC=vDCs[vO];var vMO=PDP_GetAtt(vDC,"MonthOffset","0");if((vMO=="-1")&&pAO.SelCMO)continue;if((vMO=="1")||((pAO.MV>1)&&(vIM!=vDC.Date.getUTCMonth())))break;MSC_SetHiliteDay(pAO,vDC,pSel);}}function MSC_ClearHilite(pAO){if(!pAO)return;if(pAO.HLDC){for(var vI=0;vI<pAO.HLDC.length;vI++){var vDC=pAO.HLDC[vI];if(vDC.HLSOrig!=null)vDC.style.backgroundColor=vDC.HLSOrig;}pAO.HLDC=null;}}function MSC_SetupNextClick(pAO,pDate1,pDate2,pSel,pShow){if(!pAO)return;if(pAO.UnselF)pSel=1;MSC_ClearHilite(pAO);MSC_SetHiliteRange(pAO,pDate1,pDate2,pSel);if(!pAO.MCNOn)return;var vS="";if(!pDate2)pDate2=pDate1;var vFTicks=pDate1.valueOf();var vLTicks=pDate2.valueOf();if(vFTicks!=vLTicks){if(vFTicks>vLTicks){var vTemp=pDate1;pDate1=pDate2;pDate2=vTemp;}vS=pSel?pAO.MCN2S:pAO.MCN2U;if(!vS)return;var vDate1S=PDP_FmtDate2(pDate1,pAO.MCDPat2,pAO.MCDFmt2);var vDate2S=PDP_FmtDate2(pDate2,pAO.MCDPat2,pAO.MCDFmt2);vS=vS.replace("{FIRSTDATE}",vDate1S);vS=vS.replace("{LASTDATE}",vDate2S);}else{vS=pSel?pAO.MCN1S:pAO.MCN1U;if(!vS)return;var vDateS=PDP_FmtDate2(pDate1,pAO.MCDPat,pAO.MCDFmt);vS=vS.replace("{DATE}",vDateS);}if(vS)pAO.MCNextClick=vS+"<br />";else pAO.MCNextClick=null;if(pShow)MSC_DrawMsgBody(pAO);}function MSC_ClearNextClick(pCalCId){var vAO=PDP_GetById(pCalCId).AO;if(!vAO)return;vAO.MCNextClick=null;vAO.LastNCElement=null;MSC_DrawMsgBody(vAO);}function MSC_TestShift(pAO,pE,pShift){if(pAO.MCNOn&&(pAO.MCNextClick!=null)&&(pAO.LastShift!=pShift)){if(pAO.LastNCElement)PDP_FireEvent(pAO.LastNCElement,"mouseover","MouseEvents");}}function MSC_KeyUp(pCalCId,pE){var vCal=PDP_GetById(pCalCId);MSC_TestShift(vCal.AO,pE,PDP_IsShift(pE));}function MSC_HasCellSel(pAO){return pAO.SelCells!=null;}function MSC_ClearCellSel(pAO){pAO.SelCells=null;}function MSC_SetCellSel(pAO,pCellId){if(!pAO.SelCells)pAO.SelCells=new Array();pAO.SelCells[pAO.SelCells.length]=pCellId;}function MSC_IsCellSel(pAO,pCellId){if(pAO.SelCells){for(var vI=0;vI<pAO.SelCells.length;vI++)if(pAO.SelCells[vI]==pCellId)return true;return false;}else return false;}function MSC_FirstClSl(pAO){if(pAO.SelCells)return pAO.SelCells[0];else return null;}function MSC_RemoveClSl(pAO,pCellId){var vPos=-1;for(var vI=0;vI-1<pAO.SelCells.length;vI++)if(vPos!=-1)pAO.SelCells[vI-1]=pAO.SelCells[vI];else if(pAO.SelCells[vI]==pCellId)vPos=vI;pAO.SelCells.pop();if(pAO.SelCells.length==0)pAO.SelCells=null;}function MSC_SetRange(pCalCId,pStart,pEnd,pAction){var vCal=PDP_GetById(pCalCId);if(!PDP_CtlInited(vCal))return;var vAO=vCal.AO;MSC_PrepSelDate(vAO);vAO.MaxExc=false;var vChg=false;if(!pEnd)pEnd=pStart;for(var vDate=pStart;vDate<=pEnd;vDate=new Date(vDate.valueOf()+86400000)){if(MSC_ChangeSelDates(vAO,vDate,pAction))vChg=true;if(vAO.MaxExc){MSC_DrawMsgBody(vAO);if(vAO.MaxSelMsg)alert(vAO.MaxSelMsg);}}MSC_PostToggleRange(vCal,vAO,vChg);MSC_SaveSelDate(vAO);}function MSC_GetLastClickedDate(pCalCId,pSel){var vCal=PDP_GetById(pCalCId);if(!PDP_CtlInited(vCal))return null;var vAO=vCal.AO;if(vAO.LDtTg&&(vAO.LDtSel!=null)&&(vAO.LDtSel==pSel))return vAO.LDtTg;return null;}function MSC_GetRange(pCalCId,pLow){var vCal=PDP_GetById(pCalCId);if(!PDP_CtlInited(vCal))return null;var vAO=vCal.AO;MSC_PrepSelDate(vAO);MSC_CalcFirstLast(vAO);return pLow?vAO.FirstSel:vAO.LastSel;}function MSC_GetSelectedCount(pCalCId){var vCal=PDP_GetById(pCalCId);if(!PDP_CtlInited(vCal))return null;var vAO=vCal.AO;MSC_PrepSelDate(vAO);return vAO.SelCount;}