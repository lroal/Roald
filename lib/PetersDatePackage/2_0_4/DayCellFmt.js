// Copyright 2002 - 2007 Peter L. Blum, All Rights Reserved, www.PeterBlum.com
// Peter's Date Package Release 2.0.4

function SD_FmtContent(pSDO,pDCF,pBSD,pDate){if((pDCF.DCFO==1)&&(pBSD.Fmt>""))return SD_ConvDayTokens(pDCF,pBSD,pDate,pBSD.Fmt);var vC="";if((pDCF.DCFO==2)&&(pBSD.Fmt>""))vC=pBSD.Fmt;else vC=pDCF.GetContent(pSDO,pDCF,pBSD,pDate);return SD_ConvDayTokens(pDCF,pBSD,pDate,(vC!="")?(pDCF.HTML1+vC+pDCF.HTML2):pDCF.DNFmt);}function SD_FmtHF(pSDO,pDCF,pBSD,pDate){var vB="";if((pDCF.DCFO==3)&&(pBSD.Fmt>""))vB=pBSD.Fmt;else vB=pDCF.GetBody(pSDO,pDCF,pBSD,pDate);if(vB!="")return pDCF.Hdr+vB+pDCF.Ftr;else if(pDCF.HHF)return"";else return pDCF.Hdr+"&nbsp;"+pDCF.Ftr;}function SD_BodyDesc(pSDO,pDCF,pBSD,pDate){if(pBSD.Dsc!="")return pDCF.Body;else if((pBSD.Lbl!="")&&pDCF.LND)return pBSD.Lbl;else return"";}function SD_BodyRC(pSDO,pDCF,pBSD,pDate){var vFTR=SD_NextTimeRow(pSDO,pDate);if(!vFTR)return pDCF.NRT;else switch(vFTR.Rows.length){case 0:return pDCF.NRT;case 1:return pDCF.ORT;default:return pDCF.MRT.replace("{COUNT}",vFTR.Rows.length.toString());}}function SD_BodyTR(pSDO,pDCF,pBSD,pDate){var vFTR=SD_NextTimeRow(pSDO,pDate);if(!vFTR)return"";var vHT=false;var vHA=pDCF.ARCss!="";var vHTML=pDCF.OHTML;var vRC=0;for(var vI=0;vI<vFTR.Rows.length;vI++){var vTR=vFTR.Rows[vI];var vTRHTML=pDCF.GetTimeRow(pSDO,pDCF,pBSD,pDate,vTR);if(vTRHTML=="")continue;vTRHTML=pDCF.ROHTML+SD_ConvertTimeRowTokens(pSDO,pDCF,vTR,vTRHTML)+pDCF.RCHTML;if(vI==0)vHT=(vTRHTML.indexOf("{CSS}")>-1);if(vHT){var vCss="";if(vTR.Css>"")vCss=vTR.Css;else if(vHA&&(vRC%2!=0))vCss=pDCF.ARCss;else vCss=pDCF.Css;vTRHTML=vTRHTML.replace(/\{CSS\}/g,vCss);}vHTML+=vTRHTML;vRC++;if((pDCF.MTR>0)&&(pDCF.MTR<=vRC))break;}vHTML+=pDCF.CHTML;return vHTML;}function SD_ConvertTimeRowTokens(pSDO,pDCF,pTR,pHTML){vRE=new RegExp(pDCF.CTRE,"ig");for(var vM=vRE.exec(pHTML);vM!=null;vM=vRE.exec(pHTML)){var vTN=vM[1];var vCode="var vTemp=pSDO.Map."+vTN.toUpperCase()+";";eval(vCode);vCode="var vText=pTR."+vTemp+";";eval(vCode);if(!vText)vText="&nbsp;";else if(pDCF.TDTkn&&(vTN.toUpperCase()==pDCF.TDTkn))vText=SD_TruncDesc(vText,pDCF.TrnTDsc,pDCF.TrnTSlk);pHTML=pHTML.replace("{"+vTN+"}",vText);}return pHTML;}function SD_TimeRowTable(pSDO,pDCF,pBSD,pDate,pTR){return pDCF.RCnt;}function SD_TimeRowCustom(pSDO,pDCF,pBSD,pDate,pTR){return pDCF.RCnt;}function SD_InitTimeRowSearch(pSDId){var vSDO=SD_PrepId(pSDId);vSDO.LastTRPos=-1;vSDO.LastFTR=null;}function SD_NextTimeRow(pSDId,pDate){var vSDO=SD_PrepId(pSDId);var vFTR=vSDO.LastFTR;var vP=vSDO.LastTRPos;var vL=vSDO.Times;var vR=null;if(vP==-1){vP=SD_TimeRowSearch(vL,pDate);if(vP>-1)vFTR=vL[vP];else{vP=(-vP)-1;if(vP==-1)vP=0;if(vP<vL.length)vFTR=vL[vP];}}if(vFTR!=null){if(SD_CompFTR(pDate,vFTR)==0)vR=vFTR;else if(vFTR.D<pDate){vP++;if(vP<vL.length){vFTR=vL[vP];if(SD_CompFTR(pDate,vFTR)==0)vR=vFTR;}else vFTR=null;}}vSDO.LastFTR=vFTR;vSDO.LastTRPos=vP;return vR;}function SD_TimeRowSearch(pList,pDate){if(pList.length<5){for(var vI=0;vI<pList.length;vI++){var vFTR=pList[vI];switch(SD_CompFTR(pDate,vFTR)){case-1:return-(vI+1);case 0:return vI;case 1:break;}}return-(pList.length+1);}else{var vLow=0;var vHigh=pList.length-1;var vTest=-1;while(vLow<=vHigh){var vMid=(vLow+vHigh)/2;var vTest=(vMid<1)?0:parseInt(vMid);var vR=SD_CompFTR(pDate,pList[vTest]);if(vR>0){vLow=vTest+1;continue};if(vR<0){vHigh=vTest-1;continue};return vTest;}return-(vTest+1);}}function SD_CompFTR(pDate,pFTR){if(pDate<pFTR.D)return-1;else if(pDate>pFTR.D)return 1;else return 0;}function SD_StopBubble(pE){if(pE.cancelBubble!=null)pE.cancelBubble=true;if(pE.stopPropagation)pE.stopPropagation();}function SD_InitCellPopup(pCalId,pAO,pDC){pDC.CalId=pCalId;pDC.onmouseover=new Function("SD_MouseIn('"+pCalId+"',this);");}function SD_InitPopup(pCalId){if(window.gPDP_InCB)return;PDP_RelocatePopup(PDP_GetById(pCalId+"_Exp"));var vP=PDP_GetById(pCalId+"_Exp");vP.POEXFMT=1;vP.onmouseover=SD_PUMouseIn;vP.onmouseout=SD_PUMouseOut;}function SD_MouseIn(pCalId,pDC){var vP=PDP_GetById(pCalId+"_Exp");vP.Locked=0;var vAO=PDP_GetById(pCalId).AO;if(!pDC.BSD){if(vAO.ExPUDC)SD_DelayedClosePopup(pCalId,vAO.ExPUDC);return;}if(vAO){if((pDC==vAO.ExPUDC)||(pDC==vAO.PreExPUDC))return;if(vAO.MITOID&&vAO.PreExPUDC&&(vAO.PreExPUDC!=pDC)){window.clearTimeout(vAO.MITOID);vAO.MITOID=null;}var vCount=0;vAO.PreExPUDC=pDC;if(vAO.ExpFmtter.PUDel>0)vAO.MITOID=window.setTimeout("SD_MIBody('"+pCalId+"', PDP_GetById('"+pDC.id+"'),"+vCount+");",vAO.ExpFmtter.PUDel);else SD_MIBody(pCalId,pDC);}}function SD_MIBody(pCalId,pDC,pCount){var vAO=PDP_GetById(pCalId).AO;vAO.MITOID=null;if(!vAO.PreExPUDC||vAO.PreExPUDC!=pDC){return;}vAO.PreExPUDC=null;if(vAO.ExPUDC)if(vAO.ExPUDC!=pDC){SD_DelayedClosePopup(pCalId,vAO.ExPUDC);}else return;var vP=PDP_GetById(pCalId+"_Exp");SD_InitTimeRowSearch(vAO.SDO);var vHTML=vAO.ExpFmtter.GetHTML(vAO.SDO,vAO.ExpFmtter,pDC.BSD,pDC.Date);if(vHTML!=""){if(vAO.ExpFmtter.Title){var vOld=vAO.ExpFmtter.MrgFmt;vAO.ExpFmtter.MrgFmt=2;vHTML=SD_ConvDayTokens(vAO.ExpFmtter,pDC.BSD,pDC.Date,vAO.ExpFmtter.Title)+vHTML;vAO.ExpFmtter.MrgFmt=vOld;}if(!vAO.DayRE)vAO.DayRE=/\{0\}/g;vHTML=vHTML.replace(vAO.DayRE,pDC.Date.getUTCDate());PDP_SetInnerHTML(vP,vHTML);PDP_OpenPopup(pDC.id,vP.id,false,null);if(!vP.OpenOnce){PDP_PositionPopupToToggle(pDC,vP);vP.OpenOnce=1;}vP.CalId=pCalId;vP.DC=pDC;vAO.ExPUDC=pDC;}}function SD_DelayedClosePopup(pCalId,pDC){var vAO=PDP_GetById(pCalId).AO;vAO.PostExPUDC=null;if(vAO&&vAO.ExPUDC){if(vAO.PreExPUDC&&vAO.PreExPUDC==pDC){vAO.PreExPUDC=null;if(vAO.MITOID){window.clearTimeout(vAO.MITOID);vAO.MITOID=null;}return;}if(vAO.MOTOID){window.clearTimeout(vAO.MOTOID);vAO.MOTOID=null;}vAO.PostExPUDC=pDC;if(vAO.ExpFmtter.PDDel>0)vAO.MOTOID=window.setTimeout("SD_ClosePopup(true);",vAO.ExpFmtter.PDDel);else SD_ClosePopup(true);}}function SD_ClosePopup(pDelayed){var vP=null;var vCalId=null;if(gPUNPos>-1){vP=PDP_GetById(gPopupCId[gPUNPos]);if(!vP.CalId||!vP.DC)return;vCalId=vP.CalId;}else return;var vAO=PDP_GetById(vCalId).AO;if(pDelayed&&vAO.PostExPUDC&&(vP.DC!=vAO.PostExPUDC))return;if(pDelayed&&vP.Locked)return;PDP_ClosePopup();}function SD_OnPopDown(pCalId){var vP=PDP_GetById(pCalId+"_Exp");var vAO=PDP_GetById(pCalId).AO;vP.CalId=null;vP.DC=null;vP.Locked=0;vAO.ExPUDC=null;vAO.MOTOID=null;if(window.CSC_SetFocus)CSC_SetFocus(pCalId,false);}function SD_PUMouseIn(pE){SD_PULockTest(pE,1);}function SD_PUMouseOut(pE){SD_PULockTest(pE,0);}function SD_PULockTest(pE,pLockVal){if(!pE)pE=window.event;if(!pE)return;var vP=null;if(pE.relatedTarget)vP=pE.relatedTarget;else if(pE.fromElement)vP=pE.fromElement;if(vP&&vP.POEXFMT)vP.Locked=pLockVal;else{var vPar=null;if(vP)for(vPar=PDP_ParentNode(vP);vPar&&!vPar.POEXFMT&&(vPar!=document.body);vPar=PDP_ParentNode(vPar)){}if(vPar&&vPar.POEXFMT)return;else{if(gPUNPos>-1){var vP=PDP_GetById(gPopupCId[gPUNPos]);if(vP.POEXFMT)vP.Locked=pLockVal;}}}}