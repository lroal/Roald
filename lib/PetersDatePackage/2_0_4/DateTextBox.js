// Copyright 2002 - 2007 Peter L. Blum, All Rights Reserved, www.PeterBlum.com
// Peter's Date Package Release 2.0.4
var gLastOnKeyDown=0;var gPassThroughKey=false;var gMozCnt=0;function DTB_OnKeyPress(pTBId,pBId,pE){gMozCnt++;if(!gPDP_SupportsOnKeyPress)return false;if(gPassThroughKey)return true;if((gLastOnKeyDown==0)&&(!gPDP_Gecko||(gMozCnt==1)))return false;var vShowIt=false;var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;var vKC=PDP_GetKeyCode(pE);if((vKC==null)||(vKC==0))if(gLastOnKeyDown!=0)vKC=gLastOnKeyDown;else return true;gLastOnKeyDown=0;if(vKC==9)return true;if(vTBFld.disabled||vTBFld.readOnly)return false;if(!PDP_CtlInited(vTBFld))return false;var vKCStr=String.fromCharCode(vKC);var vSKey=PDP_IsShift(pE);var vCKey=PDP_IsCtrl(pE);var vValChars="";if(vAO.ValChars)vValChars=vAO.ValChars;else{if(vAO.ExtFilter!=null)vValChars+=vAO.ExtFilter;vValChars+="1234567890";if(vAO.MonthNames!=0)vValChars+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";if(vAO.MonthNames!=null){vValChars+=vAO.DSep;}else{vValChars+=vAO.DPat+vAO.DSep;}}if((vKC<30)||(vValChars.indexOf(vKCStr)>-1)){vShowIt=true;vAO.Dirty=true;}else if((vAO.MonthNames!=0)&&(vKC>255)){vShowIt=true;vAO.Dirty=true;}else if(!DTB_CommandKeyProcessing(pTBId,pBId,vKC,vSKey,vCKey,false))vShowIt=false;if(!vShowIt)PDP_StopEvent(pE);return vShowIt;}function DTB_OnKeyDown(pTBId,pBId,pE){if(!gPDP_SupportsOnKeyPress)return false;gMozCnt=0;gPassThroughKey=false;var vKC=PDP_GetKeyCode(pE);gLastOnKeyDown=vKC;if(gPDP_Safari)return true;var vTBFld=PDP_GetById(pTBId);if(vTBFld.disabled||vTBFld.readOnly)return vKC==9;var vAO=vTBFld.AO;if(!PDP_CtlInited(vTBFld))return false;var vKCStr=String.fromCharCode(vKC);var vSKey=PDP_IsShift(pE);var vCKey=PDP_IsCtrl(pE);if(vCKey||((vKC>=33)&&(vKC<=47)&&(vKCStr!=vAO.DSep))){var vShowIt=true;if(!DTB_CommandKeyProcessing(pTBId,pBId,vKC,vSKey,vCKey,!vCKey)){gLastOnKeyDown=0;PDP_StopEvent(pE);return false;}else{gPassThroughKey=true;return true;}}else return true;}function DTB_CommandKeyProcessing(pTBId,pBId,pKeyCode,pShiftKey,pCtrlKey,pIsOnKeyDown){var vTBFld=PDP_GetById(pTBId);var vCmdId=PDP_GetCmdId(vTBFld.AO.CmdKeys,pKeyCode,pCtrlKey,pShiftKey,pIsOnKeyDown);return DTB_RunCmd(pTBId,pBId,vCmdId);}function DTB_RunCmd(pTBId,pBId,pCmdID){var vShowIt=false;switch(pCmdID){case"1":DTB_IncDate(pTBId,false);break;case"2":DTB_IncDate(pTBId,true);break;case"3":DTB_AddMonth(pTBId,-1);break;case"4":DTB_AddMonth(pTBId,1);break;case"5":DTB_AddMonth(pTBId,-12);break;case"6":DTB_AddMonth(pTBId,12);break;case"10":DTB_AssignToday(pTBId);break;case"11":DTB_PopupTheCalendar(pTBId,pBId);break;case"12":MYTB_PopupThePicker(pTBId,pBId);break;case"14":DTB_AssignSpecialDate(pTBId);break;case"21":var vCMFld=PDP_GetById(pTBId+"_CM");if(vCMFld!=null)PM_ForcePopup(vCMFld.CM);break;default:vShowIt=true;break;}return vShowIt;}function DTB_OnFocus(pTBId,pToolTip){if((pToolTip!="")&&(window.status!=null)){window.status=pToolTip;}var vAO=PDP_GetById(pTBId).AO;if(vAO&&vAO.APUF&&!vAO.APUOn&&(gPUNPos==-1)){var vT=gPUNPos;var vCal=PDP_GetById(vAO.CalID);vCal.NoFocus=1;DTB_PopupTheCalendar(pTBId,pTBId+"_PU");if(vT<gPUNPos)vAO.APUOn=1;vCal.NoFocus=0;}}function DTB_OnChange(pTBId){var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;if(!vAO)return false;if(vTBFld.value==''){if(vAO.RngMin&&vAO.RngEId)PDP_GetById(vAO.RngEId).AO.Min=null;DTB_CallOnCF(vTBFld,null,false);PDP_ClearError(pTBId);return true;}vAO.Dirty=false;var vDate=DTB_GetDateValue(pTBId);if(vDate!=null){DTB_SetDateValue(pTBId,vDate,0);DTB_ApplyRangeRules(pTBId,vDate);if(!DTB_TestInRange(pTBId,vDate,vAO.ErrAOC)){DTB_CallOnCF(vTBFld,vDate,true);return false;}if(vAO.OCalId!=null)DTB_TransferToCalendar(pTBId,vAO.OCalId);else{if(vAO.OMYPId!=null)MYTB_TransferToPicker(pTBId,vAO.OMYPId);}DTB_CallOnCF(vTBFld,vDate,false);return true;}else{DTB_CallOnCF(vTBFld,null,true);PDP_ShowError(pTBId,1,vAO.ErrAOC);return false;}}function DTB_CallOnCF(pTB,pDate,pErr){var vAO=pTB.AO;if(vAO.OCFN!=null){if((pDate==null)||pErr)if(vAO.OCFA!=1)return;eval(vAO.OCFN+"(pTB.id, pDate, pErr);");}}function DTB_OnBlur(pTBId,pUpdateStatus){if(pUpdateStatus&&(window.status!=null))window.status='';var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;if(!vAO)return false;if(vAO.Dirty){vAO.Dirty=false;if(vTBFld.fireEvent!=null)vTBFld.fireEvent('onchange');else if(document.createEvent!=null){var vEvt=document.createEvent('HTMLEvents');vEvt.initEvent('change',true,false);vTBFld.dispatchEvent(vEvt);}else{var vOnChange=vTBFld.getAttribute('onchange');var vOCStr=vOnChange.toString();var vIndex=vOCStr.indexOf('DTB_OnChange');vOCStr=vOCStr.substring(vIndex,vOCStr.length-1);vIndex=vOCStr.indexOf(')');vOCStr=vOCStr.substring(0,vIndex+1);eval(vOCStr+';');}}if(vAO.APUF&&vAO.APUOn)window.setTimeout("DTB_AutoClose('"+pTBId+"');",500);}function DTB_AutoClose(pTBId){var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;if(vAO.APUOn){vAO.APUOn=0;var vCal=PDP_GetById(vAO.CalID);if(vCal.style&&(vCal.style.visibility!='hidden'))PDP_ClosePopup();}}function DTB_ApplyRangeRules(pTBId,pDate){var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;var vSId=vAO.RngSId;var vEId=vAO.RngEId;if(vSId!=''){var vD2=DTB_GetDateValue(vSId);var vSFld=PDP_GetById(vSId);var vMD=vSFld.AO.RngMD;var vDo=(vD2!=null)&&(pDate.valueOf()<vD2.valueOf()+(vMD*86400000));if(!vDo&&vSFld.AO.RngBlk&&(vSFld.value==''))vDo=true;if(vDo&&vAO.Min&&(vAO.Min>pDate))return;if(vDo){if(vSFld.AO.RngMin)vAO.Min=pDate;if(vMD>0){var vTicks=pDate.valueOf();vTicks=vTicks-(86400000*(vMD-1))-(2*3600000);pDate=new Date(vTicks);pDate=new Date(pDate.getFullYear(),pDate.getMonth(),pDate.getDate());}DTB_SetDateValue(vSId,pDate,0);}}if(vEId!=''){var vD2=DTB_GetDateValue(vEId);var vEAO=PDP_GetById(vEId).AO;vEAO.RngMsId=2;var vMD=vEAO.RngMD;var vDo=(vD2!=null)&&(pDate.valueOf()+(vMD*86400000)>vD2.valueOf());if(!vDo&&vAO.RngBlk&&(PDP_GetById(vEId).value==''))vDo=true;if(vDo||vAO.RngMin){if(vMD>0){var vTicks=pDate.valueOf();vTicks=vTicks+(86400000*vMD)+(2*3600000);pDate=new Date(vTicks);}if(vDo)DTB_SetDateValue(vEId,pDate,0);if(vAO.RngMin){vEAO.Min=new Date(pDate.getFullYear(),pDate.getMonth(),pDate.getDate());vEAO.RngMsId=3;}}}}function DTB_GetTodayDate(pTBId){return PDP_GetById(pTBId).AO.Today;}function DTB_GetSpecialDate(pTBId){return PDP_GetById(pTBId).AO.Special;}function DTB_AssignToday(pTBId){if(!PDP_CmdCanEdit(pTBId))return;var vToday=DTB_GetTodayDate(pTBId);DTB_SetDateValue(pTBId,vToday,3);PDP_GetById(pTBId).select();DTB_ApplyRangeRules(pTBId,vToday);PDP_ClearError(pTBId);}function DTB_AssignSpecialDate(pTBId){if(!PDP_CmdCanEdit(pTBId))return;var vSpecial=DTB_GetSpecialDate(pTBId);if(vSpecial!=null){DTB_SetDateValue(pTBId,vSpecial,3);PDP_GetById(pTBId).select();DTB_ApplyRangeRules(pTBId,vSpecial);PDP_ClearError(pTBId);}}function DTB_IncDate(pTBId,pForward){if(!PDP_CmdCanEdit(pTBId))return;var vDate=null;if(PDP_GetById(pTBId).value=='')vDate=DTB_GetTodayDate(pTBId);else vDate=DTB_GetDateValue(pTBId);if(vDate!=null){if(!DTB_TestInRange(pTBId,vDate,true))return false;var vTicks=vDate.valueOf();if(pForward){vTicks=vTicks+86400000+2*3600000;}else{vTicks=vTicks-(2*3600000);}vNewDate=new Date(vTicks);vNewDate=new Date(vNewDate.getFullYear(),vNewDate.getMonth(),vNewDate.getDate());if(!DTB_TestInRange(pTBId,vNewDate,false)){setTimeout("javascript:PDP_ClearError('"+pTBId+"');",500);return false;}DTB_SetDateValue(pTBId,vNewDate,3);PDP_GetById(pTBId).select();DTB_ApplyRangeRules(pTBId,vNewDate);return true;}else{PDP_ShowError(pTBId,1,true);return false;}}function DTB_AddMonth(pTBId,pNumMonths){if(!PDP_CmdCanEdit(pTBId))return;var vDate=null;var vTBFld=PDP_GetById(pTBId);if(vTBFld.value=='')vDate=DTB_GetTodayDate(pTBId);else vDate=DTB_GetDateValue(pTBId);if(vDate!=null){if(!DTB_TestInRange(pTBId,vDate,true))return;var vNewDate=PDP_AddMonths(vDate,pNumMonths);if(!DTB_TestInRange(pTBId,vNewDate,false)){setTimeout("javascript: PDP_ClearError('"+pTBId+"');",500);if(pNumMonths>0)vNewDate=DTB_GetMaxDate(vTBFld);else vNewDate=DTB_GetMinDate(vTBFld);}DTB_SetDateValue(pTBId,vNewDate,3);PDP_GetById(pTBId).select();DTB_ApplyRangeRules(pTBId,vNewDate);}else PDP_ShowError(pTBId,1,true);}function DTB_PopupTheCalendar(pTBId,pBId){if(!PDP_CmdCanEdit(pTBId))return;var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;vAO.APUOn=0;if(!DTB_IsEmpty(pTBId)){var vDate=DTB_GetDateValue(pTBId);if(vDate!=null){if(!DTB_TestInRange(pTBId,vDate,true))return;DTB_SetDateValue(pTBId,vDate,0);DTB_ApplyRangeRules(pTBId,vDate);}else{if(vAO.ErrPU!=0){PDP_ShowError(pTBId,1,true);return;}}}var vBtn=PDP_GetById(pBId+"_TG");if(vBtn)PDP_FireEvent(vBtn,"click","MouseEvents");}function DTB_IsEmpty(pTBId){var vTBFld=PDP_GetById(pTBId);return(vTBFld.value.length==0);}function DTB_GetDateValue(pTBId){var vTBFld=PDP_GetById(pTBId);var vCT=vTBFld.value;if(vCT.length==0)return null;var vAO=vTBFld.AO;var vLastText=vAO.LastText;var vLDTicks=vAO.LastDate;var vLastDate=(vLDTicks!=0)?new Date(vLDTicks):null;if((vCT==vLastText)&&(vLastDate!=null))return vLastDate;vAO.LastText=vCT;vAO.LastDate=0;if(vAO.ADSeps){var vRE=new RegExp(vAO.ADSeps,"ig");vCT=vCT.replace(vRE,vAO.DSep);}var vDate=null;if(vTBFld.AltParse)vDate=vTBFld.AltParse(vTBFld,vCT,vLastDate);if(vDate==null)vDate=DTB_ParseDate(pTBId,vCT);if(vDate==false)vDate=null;if(vDate!=null){if(vTBFld.style){vTBFld.style.color=vAO.OrigFC;PDP_SetBkColor(vTBFld,vAO.OrigBC);}vAO.LastDate=vDate.valueOf();}else if(vTBFld.style){if(vAO.ErrFC!='')vTBFld.style.color=vAO.ErrFC;if(vAO.ErrBC!='')PDP_SetBkColor(vTBFld,vAO.ErrBC);}return vDate;}function DTB_ParseDate(pTBId,pText){var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;var vDSep=vAO.DSep;var vShort=vAO.MonthNames!=null;if(!gPDP_SupportsOnKeyPress&&vShort&&(vAO.MonthNames!=2)){var vSearch='[\\{0}0-9]+';vSearch=vSearch.replace('{0}',vDSep);exp=new RegExp(vSearch);m=pText.match(exp);if(m==null)return null;}if(vShort&&(pText.length>2)&&(pText.indexOf(vDSep)==-1)){pText=DTB_AutoFillInDateSeparators(vTBFld);}var vDate=null;var vToday=DTB_GetTodayDate(pTBId);var vYear=0;var vMonth=0;var vDay=0;var vOK=true;var vDO=DTB_GetDateOrder(vAO);var vTextBoxCount=0;var vTextBoxParts;if(vShort)vTextBoxParts=pText.split(vDSep);else{vTextBoxParts=new Array("","","");vRE=new RegExp("([A-Za-z]+)|(\\d+)","ig");var vM=vRE.exec(pText);if(!vM)return null;for(var vI=0;(vI<3);vI++){vTextBoxParts[vI]=vM[0];vM=vRE.exec(pText);if(!vM)break;}}for(var vI=0;vOK&&(vTextBoxCount<vTextBoxParts.length)&&(vI<vDO.length);vI++){switch(vDO[vI].charAt(0)){case'D':vDay=PDP_ParseInt(vTextBoxParts[vTextBoxCount]);if(!isNaN(vDay)&&(vDay>0))vTextBoxCount++;else vOK=false;break;case'M':if((vTextBoxParts.length==1)&&(vDO.length==3))break;if(vMonth==0){if(vTextBoxParts[vTextBoxCount]=='')vMonth=vToday.getMonth()+1;else vMonth=DTB_ConvertToMonthNum(vAO,vTextBoxParts[vTextBoxCount]);if(isNaN(vMonth)){vMonth=vToday.getMonth()+1;vTextBoxCount++;}else if((vMonth<=12)&&(vMonth>0))vTextBoxCount++;else vOK=false;}break;case'Y':if((vTextBoxParts.length<3)&&(vDO.length==3))break;if(vYear==0){if(vTextBoxParts[vTextBoxCount]=='')vYear=vToday.getFullYear();else vYear=PDP_ParseInt(vTextBoxParts[vTextBoxCount]);if(isNaN(vYear)){vYear=vToday.getFullYear();vTextBoxCount++;}else if(vYear<=9999){if(vYear<100){var vCenturyBreak=vAO.CntBrk;if((vCenturyBreak==0)||(vYear<vCenturyBreak))vYear=vYear+2000;else vYear=vYear+1900;}vTextBoxCount++;}else vOK=false;}break;}}if(vYear==0)vYear=vToday.getFullYear();if(vMonth==0)vMonth=vToday.getMonth()+1;if(vDay==0)vDay=1;if(vOK){vDate=new Date(vYear,vMonth-1,vDay);if((vDate.getFullYear()!=vYear)||(vDate.getMonth()!=(vMonth-1))){vDate=null;vOK=false;}}return vDate;}function DTB_ConvertToMonthNum(pAO,pMonthStr){var vChar=pMonthStr.charAt(0);if((vChar>='0')&&(vChar<='9'))return PDP_ParseInt(pMonthStr);else{var vMA=pAO.DFmt!=2?this.PDP_AbbrevMonths:this.PDP_Months;if(vMA!=null){var vMSLen=pMonthStr.length;pMonthStr=pMonthStr.toUpperCase();for(var vJ=0;vJ<=1;vJ++){for(var vI=0;vI<vMA.length;vI++){var vAMN=vMA[vI].toUpperCase();if(vMSLen>=vAMN.length){if(pMonthStr.indexOf(vAMN)==0)return vI+1;}else if(vAMN.indexOf(pMonthStr)==0)return vI+1;}if(vMSLen>2){vMSLen=2;pMonthStr=pMonthStr.substr(0,2);}else break;}return 0;}else return 0;}}function DTB_GetDateOrder(pAO){if(!pAO.DOrdA)pAO.DOrdA=pAO.DateOrder.split(" ");return pAO.DOrdA;}function DTB_SetDateValue(pTBId,pDate,pAfter){var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;var vR=pDate?PDP_FmtDate(pDate.getFullYear(),pDate.getMonth(),pDate.getDate(),vAO.DPat,vAO.DFmt):"";if(vAO.MNU)vR=vR.toUpperCase();vTBFld.value=vR;if(pAfter){vAO.Dirty=true;if((pAfter==2)||((pAfter==3)&&vAO.CmdOC))DTB_CallOnCF(vTBFld,pDate,false);else if(pAfter>=10)DTB_OnBlur(pTBId,pAfter==11);}}function DTB_GetMinDate(pTBFld){return pTBFld.AO.Min;}function DTB_GetMaxDate(pTBFld){return pTBFld.AO.Max;}function DTB_SetMinDate(pTBFld,pDate){pTBFld.AO.Min=pDate;}function DTB_SetMaxDate(pTBFld,pDate){pTBFld.AO.Max=pDate;}function DTB_TestInRange(pTBId,pDate,pShowError){var vTBFld=PDP_GetById(pTBId);var vMinDate=DTB_GetMinDate(vTBFld);if(vMinDate!=null){if(vMinDate>pDate){var vMsId=vTBFld.AO.RngMsId?vTBFld.AO.RngMsId:2;PDP_ShowError(pTBId,vMsId,pShowError);return false;}}var vMaxDate=DTB_GetMaxDate(vTBFld);if(vMaxDate!=null){if(vMaxDate<pDate){PDP_ShowError(pTBId,2,pShowError);return false;}}return true;}function DTB_AutoFillInDateSeparators(pTBFld){var vAO=pTBFld.AO;var vMLC=0;var vMLS=-1;if(vAO.MonthNames!=0){var vFoundB=false;var vText=pTBFld.value.toUpperCase();for(var vI=0;vI<vText.length;vI++){var vChar=vText.charAt(vI);if(!((vChar>='0')&&(vChar<='9'))){if(vMLS==-1)vMLS=vI;vMLC++;vFoundB=true;}else if(vFoundB)break;}}var vDO=DTB_GetDateOrder(vAO);var vOfs=new Array();for(vE=0;vE<vDO.length-1;vE++){switch(vDO[vE].charAt(0)){case'D':if((vE==0)&&(vMLS==1))vOfs[vE]=1;else vOfs[vE]=2;break;case'M':if(vMLC>0)vOfs[vE]=vMLC;else if(pTBFld.value.length%2==0)vOfs[vE]=2;else vOfs[vE]=1;break;case'Y':if(pTBFld.value.length>=5)if(pTBFld.value.length>=7)vOfs[vE]=4;else vOfs[vE]=2;break;}}var vDSep=vAO.DSep;var vR="";if(vDO.length==3){vR=pTBFld.value.substring(0,vOfs[0])+vDSep+pTBFld.value.substring(vOfs[0],vOfs[0]+vOfs[1]);if(pTBFld.value.length>4)vR=vR+vDSep+pTBFld.value.substring(vOfs[0]+vOfs[1],pTBFld.value.length+1);}else vR=pTBFld.value.substring(0,vOfs[0])+vDSep+pTBFld.value.substring(vOfs[0],pTBFld.value.length+1);return vR;}function DTB_Init(pTBId,pAltParseFN){var vFld=PDP_GetById(pTBId);var vAO=vFld.AO;vAO.LastText=vFld.value;var vDate=DTB_GetDateValue(pTBId);vAO.LastDate=(vDate!=null)?vDate.valueOf():0;vFld.AltParse=eval("new Function('pFld','pVal','pLastDate','return "+pAltParseFN+"(pFld,pVal,pLastDate)');");}function DTB_OnPopup(pTBId,pBId){if(!PDP_CmdCanEdit(pTBId))return false;var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;var vSuccess=false;var vCalId=vAO.CalID;var vCal=PDP_GetById(vCalId);if(vCal.style&&(vCal.style.visibility=='hidden')){vCal.AO.TBId=pTBId;vSuccess=DTB_TransferToCalendar(pTBId,vCalId);}return vSuccess;}function DTB_TransferToCalendar(pTBId,pCalId){var vOK=true;var vBD=false;var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;var vCal=PDP_GetById(pCalId);var vRM=PDP_SplitDate(vAO.Min,vCal.AO,"Min");if(PDP_SplitDate(vAO.Max,vCal.AO,"Max"))vRM=true;if(PDP_SplitDate(vAO.Special,vCal.AO,"Special"))vRM=true;if(PDP_SplitDate(vAO.Today,vCal.AO,"Today"))vRM=true;if(vCal.AO.SDId!=vAO.SDId){vCal.AO.SDId=vAO.SDId;vRM=true;}if(vRM)vCal.AO.MonthLoaded=false;if(DTB_IsEmpty(pTBId))vBD=true;else{var vD=DTB_GetDateValue(pTBId);if(vD!=null)if(DTB_TestInRange(pTBId,vD,false))CSC_SetDate(pCalId,vD.getFullYear(),vD.getMonth(),vD.getDate(),true,false);else vBD=true;else{if(vAO.ErrPU==0)vBD=true;else{PDP_ShowError(pTBId,1,true);vOK=false;}}}if(vBD){CSC_SetNoSelection(pCalId,true,false);if(vAO.PUMonth!=null)CSC_ViewDate(pCalId,vAO.PUYear,vAO.PUMonth);}return vOK;}function DTB_TransferCalendarToTextBox(pTBId,pCalId){if(!pTBId)pTBId=PDP_GetById(pCalId).AO.TBId;var vDate=CSC_GetDate(pCalId);DTB_SetDateValue(pTBId,vDate,11);var vTBFld=PDP_GetById(pTBId);if(vTBFld.focus&&vTBFld.select){if(vTBFld.AO.APUF)vTBFld.AO.APUOn=1;vTBFld.focus();vTBFld.select();}}function DTB_EnableMenuItem(pMnID,pCmdID){switch(pCmdID){case 3:return DTB_GetSpecialDate(gPDPMenuToken1)!=null;case 100:return PDP_GetById(gPDPMenuToken1).AO.SDId!="";}return true;}function DTB_ValidatorEvaluateIsValid(pVFld){var vTBID=PDP_GetAtt(pVFld,"controltovalidate",'');if(PDP_GetById(vTBID).value=='')return true;return DTB_GetDateValue(vTBID)!=null;}function DTB_MinMaxEvaluateIsValid(pVFld){var vTBID=PDP_GetAtt(pVFld,"controltovalidate",'');if(PDP_GetById(vTBID).value=='')return true;var vDate=DTB_GetDateValue(vTBID);if(vDate!=null){return DTB_TestInRange(vTBID,vDate,false);}else return true;}function DTB_CompareEvaluateIsValid(pVFld){var vStartDate=DTB_GetValFldDate(pVFld,"controltovalidate");var vEndDate;if(PDP_GetAtt(pVFld,"controlhookup",""))vEndDate=DTB_GetValFldDate(pVFld,"controlhookup");else{var vC=PDP_GetAtt(pVFld,"valtocomp","");vC=vC.split('|');vEndDate=new Date(vC[0],parseInt(vC[1])-1,vC[2]);}if(!vStartDate||!vEndDate)return true;vStartDate=vStartDate.valueOf();vEndDate=vEndDate.valueOf();return DTB_ValOpCompare(pVFld,vStartDate,vEndDate);}function DTB_DiffEvaluateIsValid(pVFld){var vStartDate=DTB_GetValFldDate(pVFld,"controltovalidate");var vEndDate=DTB_GetValFldDate(pVFld,"controlhookup");if((vStartDate==null)||(vEndDate==null))return true;var vDateDiff=Math.abs(vStartDate.valueOf()-vEndDate.valueOf())/86400000;vDateDiff=Math.round(vDateDiff);var vNumDays=parseInt(PDP_GetAtt(pVFld,"numdays","0"));return DTB_ValOpCompare(pVFld,vDateDiff,vNumDays);}function DTB_GetValFldDate(pVFld,pAtt){var vTBID=PDP_GetAtt(pVFld,pAtt,'');if(PDP_GetById(vTBID).value=='')return null;return DTB_GetDateValue(vTBID);}function DTB_ValOpCompare(pVFld,pFirst,pSecond){var vResult=true;switch(PDP_GetAtt(pVFld,"operator","Equal")){case"Equal":vResult=pFirst==pSecond;break;case"NotEqual":vResult=pFirst!=pSecond;break;case"GreaterThan":vResult=pFirst>pSecond;break;case"GreaterThanEqual":vResult=pFirst>=pSecond;break;case"LessThan":vResult=pFirst<pSecond;break;case"LessThanEqual":vResult=pFirst<=pSecond;break;}return vResult;}function MYTB_PopupThePicker(pTBId,pBId){if(!PDP_CmdCanEdit(pTBId))return;if(!DTB_IsEmpty(pTBId)){var vDate=DTB_GetDateValue(pTBId);if(vDate!=null){if(!DTB_TestInRange(pTBId,vDate,true))return;DTB_SetDateValue(pTBId,vDate,1);DTB_ApplyRangeRules(pTBId,vDate);}else{PDP_ShowError(pTBId,1,true);return;}}return MYTB_OnPopup(pTBId,pBId);}function MYTB_OnPopup(pTBId,pBId){if(!PDP_CmdCanEdit(pTBId))return;var vR=false;var vTBFld=PDP_GetById(pTBId);var vMYPId=vTBFld.AO.MYPId;var vMYP=PDP_GetById(vMYPId);if(vMYP.style&&(vMYP.style.visibility=='hidden')){vMYP.AO.TBId=pTBId;vR=MYTB_TransferToPicker(pTBId,vMYPId);if(vR)PDP_TogglePopup(pBId+"_TG",vMYPId);}return vR;}function MYTB_TransferToPicker(pTBId,pMYPId){var vR=true;var vTBFld=PDP_GetById(pTBId);var vAO=vTBFld.AO;var vMAO=PDP_GetById(vAO.MYPId).AO;vMAO.MinY=vAO.Min?vAO.Min.getFullYear():0;vMAO.MinM=vAO.Min?vAO.Min.getMonth()+1:0;vMAO.MaxY=vAO.Max?vAO.Max.getFullYear():0;vMAO.MaxM=vAO.Max?vAO.Max.getMonth()+1:0;if(DTB_IsEmpty(pTBId))MYTP_SelectMonthYear(pMYPId,vMAO,0,0);else{var vDate=DTB_GetDateValue(pTBId);if(vDate!=null)if(DTB_TestInRange(pTBId,vDate,false))MYTP_SelectMonthYear(pMYPId,vMAO,vDate.getMonth()+1,vDate.getFullYear());else MYTP_SelectMonthYear(pMYPId,vMAO,0,0);else{PDP_ShowError(pTBId,1,true);vR=false;}}return vR;}function MYTP_SelectMonthYear(pMYPId,pMYPAO,pMonth,pYear){if(pMYPAO.Format==1)MYP_SelectMonthYear(pMYPId,pMonth,pYear);else FMP_SelectMonthYear(pMYPId,pMonth,pYear);}function MYTB_TransferMonthYearToTextBox(pTBId,pMYPId){var vMYP=PDP_GetById(pMYPId);var vMonth=vMYP.AO.Format==1?MYP_GetMonth(pMYPId):FMP_GetMonth(pMYPId);var vYear=vMYP.AO.Format==1?MYP_GetYear(pMYPId):FMP_GetYear(pMYPId);if(!pTBId)pTBId=vMYP.AO.TBId;var vCurDate=DTB_GetDateValue(pTBId);var vAO=PDP_GetById(pTBId).AO;if(vMonth==0)vMonth=vCurDate?vCurDate.getMonth()+1:(vMYP.AO.MinM?vMYP.AO.MinM:1);if(vYear==0)vYear=vCurDate?vCurDate.getFullYear():(vMYP.AO.MinY?vMYP.AO.MinY:vAO.Today.getFullYear());var vDate=new Date(vYear,vMonth-1,1);DTB_SetDateValue(pTBId,vDate,11);var vTBFld=PDP_GetById(pTBId);if(vTBFld.focus&&vTBFld.select){vTBFld.focus();vTBFld.select();}}function DTB_SetDateYMD(pTBId,pYear,pMonth,pDay,pAfter){DTB_SetDateValue(pTBId,new Date(pYear,pMonth-1,pDay),pAfter);}